name: Extract and Sync Swagger Documentation

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  extract-and-sync-swagger:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: iemr
        options: >-
          --health-cmd="mysqladmin ping -uroot -padmin"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: Checkout API Repository
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Reporting Database
        run: |
          mysql -h127.0.0.1 -uroot -padmin -e "CREATE DATABASE IF NOT EXISTS db_reporting;"

      - name: Build Application
        run: mvn -e clean install -DskipTests

      - name: Start Application in Background
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/iemr?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
          SPRING_DATASOURCE_USERNAME: root
          SPRING_DATASOURCE_PASSWORD: admin
          SECONDARY_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/db_reporting?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
          SECONDARY_DATASOURCE_USERNAME: root
          SECONDARY_DATASOURCE_PASSWORD: admin
        run: |
          java -jar target/common-api-*.war --server.port=8083 > app.log 2>&1 &
          echo $! > app.pid

      - name: Wait for Application Startup
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:8083/v3/api-docs > /dev/null 2>&1; then
              echo "Application started successfully"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 4
          done
          echo "Application failed to start. Logs:"
          cat app.log
          exit 1

      - name: Extract Swagger JSON
        run: |
          curl -s http://localhost:8083/v3/api-docs -o swagger-common-api.json
          ls -lah swagger-common-api.json

      - name: Stop Application
        if: always()
        run: |
          kill $(cat app.pid) || true
          sleep 2

      - name: Checkout AMRIT-Docs Repository
        uses: actions/checkout@v4
        with:
          repository: DurgaPrasad-54/AMRIT-Docs
          path: amrit-docs
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Swagger File in AMRIT-Docs
        run: |
          mkdir -p amrit-docs/docs/swagger
          cp swagger-common-api.json amrit-docs/docs/swagger/
          cd amrit-docs
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add docs/swagger/swagger-common-api.json
          git commit -m "chore: auto-update Common-API swagger documentation [skip ci]" || echo "No changes to commit"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-update Common-API swagger documentation"
          branch: auto/common-api-swagger-update
          title: "chore: auto-update Common-API swagger documentation"
          body: "Automated swagger documentation sync from Common-API"
          delete-branch: true
          path: amrit-docs